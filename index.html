<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figure Your Pictures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- AdSense Script - Publisher ID updated -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9651439714273887"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f4f8;
            background-image: linear-gradient(135deg, #a7cbf5 0%, #d4a5ef 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            padding: 3rem;
            margin: 2rem;
            animation: fadeIn 1s ease-in-out;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ad-container {
            min-height: 100px;
            min-width: 100px;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            margin: 2rem 0;
            color: #64748b;
            text-align: center;
            border: 2px dashed #e2e8f0;
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6, #d946ef);
            transition: all 0.3s ease-in-out;
            border: none;
        }
        .btn-gradient:hover:not(.disabled) {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }
        .btn-gradient:active:not(.disabled) {
            transform: scale(0.98);
        }
        .download-btn {
            background-image: linear-gradient(to right, #22c55e, #16a34a);
        }
        .download-btn:hover {
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.4);
        }
        .upload-box-hover:hover {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        #three-canvas {
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            background: #282c34;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .hidden {
            display: none;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: none;
        }
        .prompt-container {
            position: relative;
        }
        .prompt-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #f1f5f9;
            color: #64748b;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .prompt-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }
        #status-box {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .gallery-card {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .gallery-card img {
            transition: transform 0.3s ease;
        }
        .gallery-card:hover img {
            transform: scale(1.05);
        }
        .caption-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-card:hover .caption-overlay {
            opacity: 1;
        }
        .gallery-card button {
            background-color: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border-radius: 0.5rem;
            padding: 0.5rem;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-card:hover button {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="flex flex-col items-center">
            <div class="flex items-center mb-6">
                <svg class="w-16 h-16 text-indigo-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <h1 class="text-6xl font-extrabold text-gray-900 text-center">Figure Your Pictures</h1>
            </div>
            <p class="text-gray-600 text-center mb-12 text-lg font-medium">Turn your photos into personalized figurines with the power of AI.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <!-- Use a label to link the div with the file input for better reliability -->
                <label for="image-upload" class="block cursor-pointer">
                    <div class="bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-3xl p-10 flex flex-col items-center justify-center transition-colors duration-200 upload-box-hover h-64" id="upload-box">
                        <div id="upload-prompt" class="flex flex-col items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            <span class="mt-4 text-indigo-700 font-semibold text-xl">Click to upload your picture</span>
                        </div>
                        <div id="processing-message" class="hidden text-center text-indigo-700 font-semibold text-xl">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading your image...
                        </div>
                        <div id="image-preview" class="w-full h-full hidden"></div>
                    </div>
                </label>
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                
                <div id="status-box">Awaiting file upload...</div>
                
                <div class="prompt-container">
                    <textarea id="prompt-input" rows="5" class="w-full p-6 border-2 border-gray-300 rounded-3xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition-all duration-200 resize-none placeholder-gray-400" placeholder="Describe the figurine features here..."></textarea>
                    <button id="clear-prompt-btn" class="prompt-btn">Clear</button>
                    <button id="suggest-prompt-btn" class="prompt-btn right-20">✨Suggest a Prompt</button>
                </div>

                <div class="flex items-center space-x-4">
                    <label for="figurine-material" class="text-gray-700 font-semibold">Material:</label>
                    <select id="figurine-material" class="flex-1 p-3 border-2 border-gray-300 rounded-2xl focus:ring-2 focus:ring-purple-300 focus:border-purple-500 transition-all duration-200">
                        <option value="vinyl">Vinyl</option>
                        <option value="porcelain">Porcelain</option>
                        <option value="metal">Metal</option>
                    </select>
                </div>
                
                <button id="generate-btn" class="w-full text-white font-bold py-5 px-8 rounded-3xl shadow-lg btn-gradient disabled">
                    Generate Figurine
                </button>
            </div>

            <div class="flex flex-col items-center justify-center">
                <!-- AdSense unit 1 -->
                <div class="ad-container w-full mb-8">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-9651439714273887"
                         data-ad-slot="1111111111"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                </div>
                
                <div id="loading" class="hidden text-purple-600 font-semibold text-lg flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Generating your figurine...</span>
                </div>
                
                <div id="result-container" class="hidden w-full h-96 flex flex-col items-center">
                    <canvas id="three-canvas" class="w-full h-full"></canvas>
                    <button id="download-btn" class="w-full mt-4 text-white font-bold py-5 px-8 rounded-3xl shadow-lg btn-gradient download-btn">
                        Download Image
                    </button>
                </div>
            </div>
        </main>
        
        <section id="gallery-section" class="mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Community Gallery</h2>
            <div id="figurine-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            </div>
        </section>

        <!-- AdSense unit 2 -->
        <div class="ad-container w-full mt-12 self-center">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-9651439714273887"
                 data-ad-slot="2222222222"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>
    </div>

    <div id="message-modal" class="message-box">
        <p id="message-text" class="text-xl font-semibold mb-4 text-gray-800"></p>
        <button onclick="document.getElementById('message-modal').style.display='none';" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-xl transition-colors duration-200">OK</button>
    </div>

    <script type="module">
        // Three.js and OrbitControls imports using reliable CDN URLs
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
        import { OrbitControls } from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/controls/OrbitControls.js';

        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Function to show a custom message box
        function showCustomMessage(message) {
            const messageModal = document.getElementById('message-modal');
            const messageText = document.getElementById('message-text');
            if (messageModal && messageText) {
                messageText.textContent = message;
                messageModal.style.display = 'block';
            }
        }

        // Set global variables from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let uploadedFile = null; // Store the file object itself
        let uploadedImageMimeType = null;
        let scene, camera, renderer, controls, figurineMesh;
        
        // API configuration
        const apiKey = ""; 
        const figurineModelName = "gemini-2.5-flash-image-preview";
        const figurineApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${figurineModelName}:generateContent?key=${apiKey}`;
        
        const textModelName = "gemini-2.5-flash-preview-05-20";
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${textModelName}:generateContent?key=${apiKey}`;

        const MAX_FILE_SIZE_MB = 4; // Maximum file size in MB
        const MAX_DIMENSION = 2048; // Maximum width or height

        // UI Elements
        const uploadInput = document.getElementById('image-upload');
        const uploadBox = document.getElementById('upload-box');
        const uploadPrompt = document.getElementById('upload-prompt');
        const processingMessage = document.getElementById('processing-message');
        const imagePreview = document.getElementById('image-preview');
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const loadingDiv = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');
        const threeCanvas = document.getElementById('three-canvas');
        const downloadBtn = document.getElementById('download-btn');
        const figurineGallery = document.getElementById('figurine-gallery');
        const figurineMaterialSelect = document.getElementById('figurine-material');
        const clearPromptBtn = document.getElementById('clear-prompt-btn');
        const suggestPromptBtn = document.getElementById('suggest-prompt-btn');


        // Default prompt
        promptInput.value = "Create a 1/7 scale commercialized figurine of the characters in the picture, in a realistic style, in a real environment. The figurine is placed on a computer desk. The figurine has a round transparent acrylic base, with no text on the base. The content on the computer screen is a 3D modeling process of this figurine. Next to the computer screen is a toy packaging box, designed in a style reminiscent of high-quality collectible figures, printed with original artwork. The packaging features two-dimensional flat illustrations.";
        
        // Initialize Firebase services and set up event listeners
        document.addEventListener('DOMContentLoaded', () => {
            
            // Wait for auth state to be ready before doing anything with Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // setupThreeJS(); // Will be called by window.onload
                        loadFigurines();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            showCustomMessage("Failed to initialize the application. Please try again.");
                        }
                    }
                });
            } catch (error) {
                showCustomMessage("Failed to initialize the application. Please try again.");
            }

            // Event listener for the file input change
            uploadInput.addEventListener('change', handleFileChange);
            
            // Event listener for the generate button
            generateBtn.addEventListener('click', handleGenerate);

            // Event listener for the clear prompt button
            clearPromptBtn.addEventListener('click', () => {
                promptInput.value = '';
            });

            // Event listener for the suggest prompt button
            suggestPromptBtn.addEventListener('click', handleSuggestPrompt);

            // Load AdSense after the DOM is ready to ensure containers have a width
            loadAdSenseAds();

        });

        window.onload = function() {
            setupThreeJS();
        }

        // Function to load AdSense ads
        function loadAdSenseAds() {
            if (window.adsbygoogle && window.adsbygoogle.push) {
                window.adsbygoogle.push({});
            } else {
                setTimeout(loadAdSenseAds, 1000); // Retry after a delay
            }
        }

        function handleFileChange(event) {
            try {
                const file = event.target.files[0];
                
                // Reset UI and state
                updateGenerateButtonState(false);
                uploadedFile = null;
                imagePreview.innerHTML = '';
                imagePreview.classList.add('hidden');
                uploadPrompt.classList.remove('hidden');
                processingMessage.classList.add('hidden');
                
                if (!file) {
                    statusBox.textContent = "Error: No file was received.";
                    statusBox.style.backgroundColor = '#fca5a5';
                    return;
                }

                // Explicitly check for file type
                if (!file.type.startsWith('image/')) {
                    statusBox.textContent = "Error: File is not a valid image.";
                    statusBox.style.backgroundColor = '#fca5a5';
                    uploadInput.value = '';
                    return;
                }
                
                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    statusBox.textContent = `Error: Image is too large (${(file.size / (1024 * 1024)).toFixed(2)}MB). Max is ${MAX_FILE_SIZE_MB}MB.`;
                    statusBox.style.backgroundColor = '#fca5a5';
                    uploadInput.value = '';
                    return;
                }

                statusBox.textContent = "File selected! Processing...";
                statusBox.style.backgroundColor = '#d1fae5';

                // Store the file object for later use
                uploadedFile = file;
                uploadedImageMimeType = file.type;

                // Show a temporary preview using createObjectURL
                const objectURL = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => {
                    URL.revokeObjectURL(objectURL); // Clean up the URL
                    if (img.width > MAX_DIMENSION || img.height > MAX_DIMENSION) {
                        statusBox.textContent = `Error: Image dimensions are too large (${img.width}x${img.height}). Max is ${MAX_DIMENSION}x${MAX_DIMENSION}.`;
                        statusBox.style.backgroundColor = '#fca5a5';
                        uploadInput.value = '';
                        uploadedFile = null;
                        return;
                    }
                    
                    imagePreview.innerHTML = `<img src="${objectURL}" class="w-full h-full object-contain rounded-xl">`;
                    imagePreview.classList.remove('hidden');
                    processingMessage.classList.add('hidden');
                    uploadPrompt.classList.add('hidden');
                    updateGenerateButtonState(true);
                    statusBox.textContent = "Preview generated successfully! You can now generate your figurine.";
                    statusBox.style.backgroundColor = '#d1fae5';
                };

                img.onerror = () => {
                    URL.revokeObjectURL(objectURL);
                    statusBox.textContent = "Error: The uploaded file could not be loaded as an image.";
                    statusBox.style.backgroundColor = '#fca5a5';
                    uploadInput.value = '';
                    uploadedFile = null;
                    processingMessage.classList.add('hidden');
                    uploadPrompt.classList.remove('hidden');
                };

                img.src = objectURL;
                processingMessage.classList.remove('hidden');

            } catch (error) {
                statusBox.textContent = `An unexpected error occurred: ${error.message}.`;
                statusBox.style.backgroundColor = '#fca5a5';
                console.error("File upload error:", error);
                uploadInput.value = '';
                uploadedFile = null;
            }
        }


        function updateGenerateButtonState(isEnabled) {
            generateBtn.disabled = !isEnabled;
            if (isEnabled) {
                generateBtn.classList.remove('disabled');
            } else {
                generateBtn.classList.add('disabled');
            }
        }

        async function handleGenerate() {
            if (!uploadedFile) {
                showCustomMessage("Please upload a valid image first.");
                return;
            }
            
            resultContainer.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            updateGenerateButtonState(false);

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUri = e.target.result;
                const dataUrlParts = dataUri.split(',');
                const uploadedImageData = dataUrlParts.length > 1 ? dataUrlParts[1] : null;

                if (!uploadedImageData) {
                    const message = "Failed to convert image to Base64 data.";
                    showCustomMessage(message);
                    loadingDiv.classList.add('hidden');
                    updateGenerateButtonState(true);
                    return;
                }
                
                const userPrompt = `${promptInput.value}. Material is ${figurineMaterialSelect.value}.`;

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: uploadedImageMimeType,
                                        data: uploadedImageData
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"],
                    },
                };

                try {
                    let response = null;
                    let retries = 0;
                    const maxRetries = 5;
                    const baseDelay = 1000;

                    while (retries < maxRetries) {
                        try {
                            response = await fetch(figurineApiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (response.status !== 429) {
                                break;
                            }
                        } catch (error) {}
                        retries++;
                        await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, retries)));
                    }

                    if (!response || !response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];

                    if (part && part.inlineData && part.inlineData.data) {
                        const base64Data = part.inlineData.data;
                        const mimeType = part.inlineData.mimeType || 'image/png';
                        const dataUri = `data:${mimeType};base64,${base64Data}`;
                        
                        loadFigurineTo3D(dataUri);
                        resultContainer.classList.remove('hidden');
                        
                        // Add download functionality
                        downloadBtn.onclick = () => {
                            const a = document.createElement('a');
                            a.href = dataUri;
                            a.download = 'figurine.png';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        };

                        await saveFigurine(base64Data, userPrompt);
                        showCustomMessage("Figurine generated successfully!");
                    } else {
                        const message = "Oops! The AI did not return an image. This can happen with certain prompts.";
                        showCustomMessage(message);
                    }
                } catch (error) {
                    const message = `An error occurred: ${error.message}. Please try again.`;
                    showCustomMessage(message);
                } finally {
                    loadingDiv.classList.add('hidden');
                    updateGenerateButtonState(true);
                }
            };
            reader.readAsDataURL(uploadedFile);
        }

        async function handleSuggestPrompt() {
            if (!uploadedFile) {
                showCustomMessage("Please upload a valid image first.");
                return;
            }

            const oldPromptText = promptInput.value;
            promptInput.value = 'Generating prompt suggestions...';
            suggestPromptBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUri = e.target.result;
                const dataUrlParts = dataUri.split(',');
                const uploadedImageData = dataUrlParts.length > 1 ? dataUrlParts[1] : null;

                if (!uploadedImageData) {
                    showCustomMessage("Failed to convert image for prompt suggestion.");
                    promptInput.value = oldPromptText;
                    suggestPromptBtn.disabled = false;
                    return;
                }

                const systemInstruction = "Act as a creative prompt engineer for an AI image generator. Based on the following image and user's initial description, suggest a detailed and descriptive prompt for a realistic figurine. The prompt should be a single paragraph and start with 'A realistic figurine...'";

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: `User's description: ${oldPromptText}` },
                                {
                                    inlineData: {
                                        mimeType: uploadedImageMimeType,
                                        data: uploadedImageData
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemInstruction }]
                    }
                };
                
                try {
                    const response = await fetch(textApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const suggestedPrompt = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (suggestedPrompt) {
                        promptInput.value = suggestedPrompt;
                    } else {
                        showCustomMessage("Could not generate a prompt. Please try again.");
                        promptInput.value = oldPromptText;
                    }
                } catch (error) {
                    showCustomMessage(`An error occurred while suggesting a prompt: ${error.message}.`);
                    promptInput.value = oldPromptText;
                } finally {
                    suggestPromptBtn.disabled = false;
                }
            };
            reader.readAsDataURL(uploadedFile);
        }

        async function handleGenerateCaption(imageData) {
            const oldCaptionText = "Generating caption...";
            showCustomMessage(oldCaptionText);

            const systemInstruction = "Act as a social media content creator. Based on this image, write a short, creative, and witty caption. The caption should be 1-2 sentences and sound engaging for a social media audience.";

            const payload = {
                contents: [
                    {
                        parts: [
                            { text: "Generate a caption for this figurine:" },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: imageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                    }
            };

            try {
                const response = await fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error.message || response.statusText}`);
                }

                const result = await response.json();
                const generatedCaption = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedCaption) {
                    showCustomMessage(generatedCaption);
                } else {
                    showCustomMessage("Could not generate a caption. The AI might not have enough information.");
                }
            } catch (error) {
                showCustomMessage(`An error occurred while generating the caption: ${error.message}.`);
            }
        }


        // Initialize Three.js scene
        function setupThreeJS() {
            if (!threeCanvas) {
                console.error("3D canvas element not found.");
                return;
            }
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, threeCanvas.offsetWidth / threeCanvas.offsetHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, antialias: true, alpha: true });
            renderer.setSize(threeCanvas.offsetWidth, threeCanvas.offsetHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            // Create a simple plane for the figurine
            const geometry = new THREE.PlaneGeometry(3, 3);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, side: THREE.DoubleSide });
            figurineMesh = new THREE.Mesh(geometry, material);
            scene.add(figurineMesh);

            camera.position.z = 5;

            // Add OrbitControls for user interaction
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function onWindowResize() {
            if (!threeCanvas || !camera || !renderer) return;
            camera.aspect = threeCanvas.offsetWidth / threeCanvas.offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(threeCanvas.offsetWidth, threeCanvas.offsetHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        // Load figurine from a data URI onto the 3D model
        function loadFigurineTo3D(dataUri) {
            if (!figurineMesh) {
                return;
            }
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(dataUri, (texture) => {
                const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
                figurineMesh.material = material;
            }, undefined, (err) => {
                showCustomMessage("Failed to load the figurine's texture. Please try again.");
            });
        }

        // Save figurine data to Firestore
        async function saveFigurine(imageData, userPrompt) {
            if (!userId) {
                return;
            }
            try {
                const figurinesCollection = collection(db, `/artifacts/${appId}/public/data/figurines`);
                await addDoc(figurinesCollection, {
                    prompt: userPrompt,
                    imageData: imageData,
                    createdAt: serverTimestamp(),
                    userId: userId
                });
            } catch (error) {
                console.error("Error saving figurine to Firestore:", error);
            }
        }

        // Load figurines from Firestore and update the gallery
        function loadFigurines() {
            const figurinesCollection = collection(db, `/artifacts/${appId}/public/data/figurines`);
            const q = query(figurinesCollection);
            
            onSnapshot(q, (snapshot) => {
                const figurines = [];
                snapshot.forEach(doc => {
                    figurines.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by creation time, newest first
                figurines.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                figurineGallery.innerHTML = ''; // Clear previous content
                if (figurines.length === 0) {
                    figurineGallery.innerHTML = '<p class="text-center text-gray-500 col-span-full">No figurines in the gallery yet. Be the first to create one!</p>';
                } else {
                    figurines.forEach(figurine => {
                        if (figurine.imageData) {
                            const card = document.createElement('div');
                            card.className = 'gallery-card relative group';

                            const img = document.createElement('img');
                            img.src = `data:image/jpeg;base64,${figurine.imageData}`;
                            img.alt = figurine.prompt;
                            img.className = 'w-full h-auto rounded-xl shadow-lg cursor-pointer transition-transform duration-200';
                            
                            const captionBtn = document.createElement('button');
                            captionBtn.className = 'absolute top-2 right-2 p-2 bg-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                            captionBtn.innerHTML = '<span class="text-xl">✨</span>'; // Using sparkle emoji as a button icon
                            captionBtn.onclick = (e) => {
                                e.stopPropagation();
                                handleGenerateCaption(figurine.imageData);
                            };

                            img.onclick = () => {
                                loadFigurineTo3D(img.src);
                                resultContainer.classList.remove('hidden');
                            };
                            
                            card.appendChild(img);
                            card.appendChild(captionBtn);
                            figurineGallery.appendChild(card);
                        }
                    });
                }
            }, (error) => {
                console.error("Error fetching figurines from Firestore:", error);
            });
        }
    </script>
</body>
</html>
